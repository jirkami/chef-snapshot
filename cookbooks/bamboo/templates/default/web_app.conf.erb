#
#  Dynamically generated by Chef on <%= node["fqdn"] %>
#  Local modifications will be overwritten by Chef.
#
#TODO: ssl yes or no
<VirtualHost *:<%= node['bamboo']['apache2']['port'] %>>
	<% unless node['bamboo']['apache2']['virtual_host_name'].empty? -%>
	ServerName <%= node['bamboo']['apache2']['virtual_host_name'] %>
	<% end -%>
	<% unless node['bamboo']['apache2']['virtual_host_alias'].empty? -%>
	<% virtual_host_aliases = node['bamboo']['apache2']['virtual_host_alias'].kind_of?(Array) ? node['bamboo']['apache2']['virtual_host_alias'] : [ node['bamboo']['apache2']['virtual_host_alias'] ] -%>
	<% virtual_host_aliases.each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['bamboo']['home_dir'] %>
	
	<% unless node['bamboo']['apache2']['error_docs']['e503'].empty? -%>
	ErrorDocument 503 <%= node['bamboo']['apache2']['error_docs']['e503'] %>
	<% end -%>
	
	CustomLog <%= node['bamboo']['apache2']['access_log'].empty? ? node['apache']['log_dir']+"/bamboo-access.log" : node['bamboo']['apache2']['access_log'] %> combined
	ErrorLog <%= node['bamboo']['apache2']['error_log'].empty? ? node['apache']['log_dir']+"/bamboo-error.log" : node['bamboo']['apache2']['error_log'] %>
	LogLevel warn
    ProxyRequests Off
    ProxyPreserveHost On

	<Proxy *>
      <% if node['apache']['version'] == '2.4' -%>
        Require all granted
      <% else -%>
		Order Deny,Allow
		Allow from all
    <% end -%>
	</Proxy>

	ProxyPass        / http://localhost:8085/ connectiontimeout=5 timeout=300
	ProxyPassReverse / http://localhost:8085/
</VirtualHost>

<VirtualHost *:<%= node['bamboo']['apache2']['ssl']['port'] %>>
	<% unless node['bamboo']['apache2']['virtual_host_name'].empty? -%>
	ServerName <%= node['bamboo']['apache2']['virtual_host_name'] %>
	<% end -%>
	<% unless node['bamboo']['apache2']['virtual_host_alias'].empty? -%>
	<% virtual_host_aliases = node['bamboo']['apache2']['virtual_host_alias'].kind_of?(Array) ? node['bamboo']['apache2']['virtual_host_alias'] : [ node['bamboo']['apache2']['virtual_host_alias'] ] -%>
	<% virtual_host_aliases.each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['bamboo']['home_dir'] %>

	<% unless node['bamboo']['apache2']['error_docs']['e503'].empty? -%>
	ErrorDocument 503 <%= node['bamboo']['apache2']['error_docs']['e503'] %>
	<% end -%>

	CustomLog <%= node['bamboo']['apache2']['ssl']['access_log'].empty? ? node['apache']['log_dir']+"/bamboo-ssl-access.log" : node['bamboo']['apache2']['ssl']['access_log'] %> combined
	ErrorLog <%= node['bamboo']['apache2']['ssl']['error_log'].empty? ? node['apache']['log_dir']+"/bamboo-ssl-error.log" : node['bamboo']['apache2']['ssl']['error_log'] %>
	LogLevel warn
    ProxyRequests Off
    ProxyPreserveHost On

	<Proxy *>
      <% if node['apache']['version'] == '2.4' -%>
         Require all granted
      <% else -%>
        Order Deny,Allow
        Allow from all
      <% end -%>
	</Proxy>
	ProxyPass        / http://localhost:8085/ connectiontimeout=5 timeout=300
	ProxyPassReverse / http://localhost:8085/

	SSLEngine on
	SSLCertificateFile <%= node['bamboo']['apache2']['ssl']['certificate_file'] %>
	SSLCertificateKeyFile <%= node['bamboo']['apache2']['ssl']['key_file'] %>
	<% unless node['bamboo']['apache2']['ssl']['chain_file'].empty? -%>
	SSLCertificateChainFile <%= node['bamboo']['apache2']['ssl']['chain_file'] %>
	<% end -%>
</VirtualHost>
